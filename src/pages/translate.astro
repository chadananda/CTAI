---
export const prerender = false;
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';
const allWorks = await getCollection('works');
const byAuthor = new Map();
for (const entry of allWorks) {
  const author = entry.data.author;
  if (!byAuthor.has(author)) byAuthor.set(author, []);
  byAuthor.get(author).push(entry.data);
}
const authorOrder = ["Baha'u'llah", "The Bab", "Abdu'l-Baha", "Shoghi Effendi"];
const sortedAuthors = [...byAuthor.keys()].sort(
  (a, b) => (authorOrder.indexOf(a) === -1 ? 99 : authorOrder.indexOf(a)) - (authorOrder.indexOf(b) === -1 ? 99 : authorOrder.indexOf(b))
);
const totalWorks = allWorks.length;
const translatedCount = allWorks.filter(w => w.data.translation_status === 'complete').length;
---

<Base title="Translate" description="Browse 188 sacred texts awaiting translation by the CTAI committee translation system.">
  <div class="mb-8">
    <h1 class="text-3xl font-semibold text-ink-100 mb-2">Translation Catalog</h1>
    <p class="text-ink-400 mb-4">Sacred texts in Arabic and Persian, awaiting committee translation into English.</p>
    <div class="flex gap-6 text-sm">
      <div><span class="text-ink-100 font-mono">{totalWorks}</span> <span class="text-ink-500">total works</span></div>
      <div><span class="text-emerald-400 font-mono">{translatedCount}</span> <span class="text-ink-500">translated</span></div>
      <div><span class="text-gold-400 font-mono">{totalWorks - translatedCount}</span> <span class="text-ink-500">awaiting translation</span></div>
    </div>
  </div>
  <div class="mb-8">
    <input
      type="search"
      id="work-search"
      placeholder="Filter works by title..."
      class="w-full max-w-md px-4 py-2 text-sm bg-ink-800/60 border border-ink-700/40 rounded-lg text-ink-300 placeholder:text-ink-600 focus:border-gold-500/40 focus:outline-none"
    />
  </div>
  {sortedAuthors.map(author => {
    const works = byAuthor.get(author).sort((a, b) => a.title.localeCompare(b.title));
    const slug = works[0].author_slug;
    return (
      <section class="mb-12" data-author-section>
        <div class="flex items-center gap-3 mb-4">
          <h2 class="text-xl font-semibold text-ink-200">{author}</h2>
          <span class="text-xs text-ink-500 font-mono">{works.length} works</span>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          {works.map(w => {
            const isTranslated = w.translation_status === 'complete';
            const iconChar = w.title_original ? w.title_original.charAt(0) : w.title.charAt(0);
            const iconColor = w.language === 'ar'
              ? 'bg-gold-400/10 text-gold-400 border border-gold-500/20'
              : 'bg-emerald-400/10 text-emerald-400 border border-emerald-500/20';
            return (
              <a href={`/translations/${w.author_slug}/${w.doc_id}/`}
                 class="block group"
                 data-work-card
                 data-title={`${w.title} ${w.title_original || ''}`}>
                <div class="p-4 bg-ink-800/40 rounded-lg border border-ink-700/40 hover:border-gold-500/30 transition-all">
                  <div class="flex items-start gap-3 mb-3">
                    <div class={`work-icon ${iconColor}`}>{iconChar}</div>
                    <div class="min-w-0 flex-1">
                      <div class="font-semibold text-ink-100 text-sm group-hover:text-gold-400 transition-colors">{w.title}</div>
                      {w.title_original && (
                        <div class="font-arabic text-ink-400 text-sm mt-0.5" dir="rtl">{w.title_original}</div>
                      )}
                    </div>
                    {isTranslated ? (
                      <span class="text-[10px] uppercase tracking-wider text-emerald-400 bg-emerald-400/10 px-1.5 py-0.5 rounded shrink-0">Translated</span>
                    ) : (
                      <span class="text-[10px] uppercase tracking-wider text-gold-400/60 bg-gold-400/5 px-1.5 py-0.5 rounded shrink-0">Untranslated</span>
                    )}
                  </div>
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-[10px] uppercase tracking-wider text-ink-500 bg-ink-700 px-1.5 py-0.5 rounded">
                      {w.language === 'ar' ? 'Arabic' : 'Persian'}
                    </span>
                    {w.se_translation && (
                      <span class="text-[10px] uppercase tracking-wider text-gold-400 bg-gold-400/10 px-1.5 py-0.5 rounded">SE Corpus</span>
                    )}
                    {w.has_english_translation && (
                      <span class="text-[10px] uppercase tracking-wider text-emerald-400 bg-emerald-400/10 px-1.5 py-0.5 rounded">Has English</span>
                    )}
                    {w.word_count && (
                      <span class="text-[10px] text-ink-600 font-mono">{w.word_count.toLocaleString()} words</span>
                    )}
                  </div>
                  {!isTranslated && w.source_preview && (
                    <div class="manuscript mt-2" style="max-height: 120px;">
                      <div class="manuscript-text text-xs leading-relaxed" style="line-height: 2;">{w.source_preview.slice(0, 300)}</div>
                      <div class="manuscript-fade"></div>
                    </div>
                  )}
                  {isTranslated ? (
                    <div class="mt-3 text-xs text-gold-400 group-hover:text-gold-300">Read translation &rarr;</div>
                  ) : (
                    <div class="mt-3 flex items-center justify-between">
                      {w.estimated_cost_usd ? (
                        <span class="text-xs text-ink-500">Est. ${w.estimated_cost_usd.toFixed(0)}</span>
                      ) : (
                        <span class="text-xs text-ink-600">Cost TBD</span>
                      )}
                      <span class="text-xs text-gold-400 group-hover:text-gold-300">Sponsor this translation &rarr;</span>
                    </div>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      </section>
    );
  })}
  <script is:inline>
    const searchInput = document.getElementById('work-search');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        document.querySelectorAll('[data-work-card]').forEach(card => {
          const title = card.dataset.title.toLowerCase();
          card.style.display = title.includes(q) ? '' : 'none';
        });
        document.querySelectorAll('[data-author-section]').forEach(section => {
          const visibleCards = section.querySelectorAll('[data-work-card]:not([style*="display: none"])');
          section.style.display = visibleCards.length ? '' : 'none';
        });
      });
    }
  </script>
</Base>
