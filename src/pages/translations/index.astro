---
export const prerender = false;
import Base from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';
import { coverUrl } from '../../lib/imgix.js';
const allWorks = await getCollection('works');

import { estimateCost, fmtCost } from '../../lib/cost-estimate.js';
import { suras as quranSurasWithSlugs } from '../../lib/quran.js';

const MIN_3ROW = 9;
const byAuthor = new Map();
for (const entry of allWorks) {
  const a = entry.data.author;
  if (!byAuthor.has(a)) byAuthor.set(a, []);
  byAuthor.get(a).push({ ...entry.data, est: estimateCost(entry.data) });
}
for (const [, works] of byAuthor) {
  works.sort((a, b) => {
    if (a.is_best_known && !b.is_best_known) return -1;
    if (!a.is_best_known && b.is_best_known) return 1;
    return a.title.localeCompare(b.title);
  });
}
const sacredOrder = ["Bah\u00e1\u2019u\u2019ll\u00e1h", "The B\u00e1b", "\u2018Abdu\u2019l-Bah\u00e1", "Shoghi Effendi"];
const sortedAuthors = [...byAuthor.keys()].sort((a, b) => {
  const ai = sacredOrder.indexOf(a), bi = sacredOrder.indexOf(b);
  return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
});
const translatedWorks = allWorks.filter(w => w.data.translation_status === 'complete');

// Map Qur'an suras to the same shape as work cards
const qWorks = quranSurasWithSlugs.map(s => {
  const w = {
    title: s.tname,
    title_english: s.ename,
    title_original: s.name,
    author: "The Qur\u2019\u00e1n",
    author_slug: 'quran',
    doc_id: s.slug,
    language: 'ar',
    category: 'islam',
    subject: s.type,
    word_count: s.word_count,
    source_preview: s.preview,
    source_url: `https://tanzil.net/#${s.index}:1`,
    description: `Sura ${s.index} \u2014 ${s.ayas} verses \u2014 ${s.type}. Revelation order: ${s.order}.`,
    subjects: [s.type, `${s.ayas} verses`, `Revelation #${s.order}`],
    is_best_known: false,
    cover_image: null,
    sura_index: s.index,
    sura_slug: s.slug,
  };
  w.est = estimateCost(w);
  return w;
});
---

<Base title="Translate" description="Browse and sponsor translations of sacred tablets and scholarly works.">
  <div class="flex flex-col lg:flex-row gap-6">
    <!-- Sidebar -->
    <aside class="lg:w-56 shrink-0">
      <div class="lg:sticky lg:top-20 lg:max-h-[calc(100vh-6rem)] lg:overflow-y-auto space-y-4 pb-4">
        <input type="search" id="work-search" placeholder="Search works..."
          class="w-full px-3 py-1.5 text-xs bg-ink-800/60 border border-ink-700/40 rounded-lg text-ink-300 placeholder:text-ink-600 focus:border-gold-500/40 focus:outline-none"/>
        <div class="flex flex-wrap gap-1.5">
          <button data-filter="all" class="filter-btn px-2 py-0.5 text-[10px] font-mono uppercase tracking-wider rounded border border-ink-700/40 bg-ink-700 text-ink-200">All</button>
          <button data-filter="sacred" class="filter-btn px-2 py-0.5 text-[10px] font-mono uppercase tracking-wider rounded border border-ink-700/40 text-ink-500">Sacred</button>
          <button data-filter="scholarly" class="filter-btn px-2 py-0.5 text-[10px] font-mono uppercase tracking-wider rounded border border-ink-700/40 text-ink-500">Scholarly</button>
          <button data-filter="translated" class="filter-btn px-2 py-0.5 text-[10px] font-mono uppercase tracking-wider rounded border border-ink-700/40 text-ink-500">Translated</button>
        </div>
        <nav class="hidden lg:block">
          <h3 class="text-[10px] uppercase tracking-wider text-ink-600 mb-2 font-mono">Browse by Author</h3>
          <ul class="space-y-1.5">
            {sortedAuthors.map(author => {
              const slug = byAuthor.get(author)[0].author_slug;
              const count = byAuthor.get(author).length;
              return (
                <li>
                  <a href={`#${slug}`} class="flex justify-between items-center text-xs text-ink-400 hover:text-gold-400 transition-colors">
                    <span class="truncate">{author}</span>
                    <span class="text-ink-600 font-mono text-[10px] ml-2">{count}</span>
                  </a>
                </li>
              );
            })}
            <li>
              <a href="#quran" class="flex justify-between items-center text-xs text-ink-400 hover:text-emerald-400 transition-colors">
                <span class="truncate">The Qurʼán</span>
                <span class="text-ink-600 font-mono text-[10px] ml-2">114</span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="hidden lg:block">
          <h3 class="text-[10px] uppercase tracking-wider text-ink-600 mb-2 font-mono">Translated Works</h3>
          {translatedWorks.length === 0 ? (
            <p class="text-[11px] text-ink-600 italic leading-relaxed">None yet. Be the first to sponsor a translation.</p>
          ) : (
            <ul class="space-y-1">
              {translatedWorks.map(w => (
                <li>
                  <a href={`/translations/${w.data.author_slug}/${w.data.doc_id}/`}
                     class="text-xs text-emerald-400/80 hover:text-emerald-300 transition-colors">{w.data.title}</a>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <div class="flex-1 min-w-0">
      <div class="mb-8">
        <h1 class="text-2xl font-semibold text-ink-100 mb-3">Some Documents to Translate</h1>
        <p class="text-ink-400 text-sm leading-relaxed max-w-2xl mb-2">
          Here are a whole bunch of sacred tablets, prayers, and scholarly works in Arabic and Persian &mdash;
          many of which have never been properly translated into English. Each one can be translated by our
          committee translation system: three AI translators deliberating in rounds, guided by
          Shoghi Effendi&rsquo;s concordance of translation precedents.
        </p>
        <p class="text-ink-500 text-sm leading-relaxed max-w-2xl">
          The multi-pass consultative process produces remarkably good translations but is expensive to run &mdash;
          this isn&rsquo;t a bulk operation. So I&rsquo;ve built a sponsorship model: you pay for a translation you want,
          and it becomes permanently available for everyone. All translations enter the <span class="text-gold-400/80">public domain</span>
          so we can all explore together.
        </p>
      </div>

      {sortedAuthors.map(author => {
        const works = byAuthor.get(author);
        const slug = works[0].author_slug;
        const category = works[0].category || 'sacred';
        const isSacred = category === 'sacred';
        const hasOverflow = works.length > MIN_3ROW;
        return (
          <section class="mb-8" id={slug} data-author-section data-category={category}>
            <div class="flex items-baseline gap-2 mb-3 border-b border-ink-800/60 pb-1.5">
              <h2 class="text-sm font-semibold text-ink-300">{author}</h2>
              {!isSacred && <span class="text-[8px] uppercase tracking-wider text-blue-400/50 bg-blue-400/5 px-1 py-0.5 rounded">Scholarly</span>}
            </div>
            <div class={`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1.5 ${hasOverflow ? 'bookshelf-clamped' : ''}`}>
              {works.map((w, i) => {
                const isTranslated = w.translation_status === 'complete';
                const searchText = [w.title, w.title_english, w.title_original, w.subject, w.description, ...(w.subjects || [])].filter(Boolean).join(' ');
                return (
                  <div class="work-card group cursor-pointer px-1 pt-1 pb-0.5 rounded-lg border border-ink-700/30 bg-ink-800/20 hover:border-ink-600/50 hover:bg-ink-800/40 transition-colors"
                       data-work-card
                       data-idx={i}
                       data-category={w.category || 'sacred'}
                       data-title={searchText}
                       data-doc-id={w.doc_id}
                       data-sacred={isSacred ? '1' : '0'}
                       data-translated={isTranslated ? '1' : '0'}
                       data-json={JSON.stringify({
                         title: w.title,
                         title_english: w.title_english,
                         title_original: w.title_original,
                         author: w.author,
                         author_slug: w.author_slug,
                         doc_id: w.doc_id,
                         language: w.language,
                         category: w.category,
                         subject: w.subject,
                         word_count: w.word_count,
                         source_preview: w.source_preview,
                         source_url: w.source_url,
                         se_translation: w.se_translation,
                         has_english_translation: w.has_english_translation,
                         volume: w.volume,
                         volumes_total: w.volumes_total,
                         date_composed: w.date_composed,
                         translation_style: w.translation_style,
                         author_original: w.author_original,
                         description: w.description,
                         subjects: w.subjects,
                         is_best_known: w.is_best_known,
                         author_bio: w.author_bio,
                         cover_image: w.cover_image,
                         est: w.est,
                         translated: isTranslated,
                       })}>
                    <div class="flex items-start gap-1.5">
                      {w.cover_image ? (
                        <img src={coverUrl(w.doc_id, { width: 86 })}
                             alt={w.title}
                             width="43" height="60"
                             loading="lazy"
                             class="shrink-0 rounded-sm bg-ink-800 object-contain" style="width:43px;height:60px;"/>
                      ) : (
                        <svg viewBox="0 0 40 56" width="43" height="60" class="shrink-0 rounded-sm" style="width:43px;height:60px;" xmlns="http://www.w3.org/2000/svg"
                             role="img" aria-label={w.title}>
                          <rect width="40" height="56" rx="2" fill={isSacred ? '#2a1f15' : '#1a2030'}/>
                          <rect x="0" y="0" width="2.5" height="56" fill="rgba(0,0,0,0.25)" rx="1"/>
                          <text x="21" y="28" text-anchor="middle" dominant-baseline="central"
                                font-family="'Scheherazade New',serif" font-size="14"
                                fill={isSacred ? '#b8860b' : '#60a5fa'} opacity="0.5">
                            {w.title_original ? w.title_original.charAt(0) : (w.language === 'ar' ? '\u0639' : '\u0641')}
                          </text>
                        </svg>
                      )}
                      <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-1">
                          <span class="text-[11px] text-ink-200 leading-snug group-hover:text-ink-100 transition-colors truncate">
                            {w.title}
                          </span>
                          <span class="flex-1"></span>
                          {w.is_best_known && <span class="shrink-0 text-gold-500 text-[10px]" title="Best-Known Work">&#9733;</span>}
                        </div>
                        {w.title_english && (
                          <div class="text-[10px] text-ink-400 italic leading-snug truncate">{w.title_english}</div>
                        )}
                        <div class="card-bottom-row">
                          <div class="min-w-0 overflow-hidden text-left">
                            {w.title_original ? (
                              <span class="font-arabic text-[13px] text-ink-300 block truncate leading-relaxed">{w.title_original}</span>
                            ) : isTranslated ? (
                              <span class="text-[8px] text-emerald-400 uppercase tracking-wider">done</span>
                            ) : null}
                          </div>
                          <div class="shrink-0">
                            {w.est && (
                              <span class="text-[9px] font-mono text-ink-400 whitespace-nowrap">
                                {w.est.paras}&thinsp;pg ~<span class="text-gold-400/80">{fmtCost(w.est.total)}</span>
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            {hasOverflow && (
              <button class="show-more-btn w-full mt-3 py-1.5 text-xs text-ink-500 hover:text-ink-300 border border-ink-800/40 rounded-lg hover:border-ink-700/60 transition-colors"
                      data-total={works.length}>
                Show all {works.length}
              </button>
            )}
          </section>
        );
      })}

      <!-- Islam Section: Qur'an -->
      <section class="mb-8 mt-12 pt-8 border-t border-ink-700/40" id="quran" data-author-section data-category="islam">
        <div class="flex items-baseline gap-3 mb-2">
          <h2 class="text-sm font-semibold text-ink-300">The Qurʼán</h2>
          <span class="text-[8px] uppercase tracking-wider text-emerald-400/50 bg-emerald-400/5 px-1 py-0.5 rounded">114 Suras · 6,236 Verses</span>
        </div>
        <p class="text-ink-400 text-xs leading-relaxed max-w-2xl mb-2">
          Have you ever wondered what a translation of the Qurʼán might look like if Shoghi Effendi had done it?
          We have passages of the Qurʼán throughout the 11 translations of Shoghi Effendi which have a power
          and resonance beyond any other in English. What if&hellip;
        </p>
        <p class="text-ink-500 text-xs leading-relaxed max-w-2xl mb-3">
          Uthmani script · Kufan verse numbering · sourced from
          <a href="https://tanzil.net" class="text-gold-400/70 hover:text-gold-400 transition-colors">Tanzil</a>
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1.5 bookshelf-clamped">
          {qWorks.map((w, i) => {
            const searchText = [w.title, w.title_english, w.title_original, w.subject, w.description, ...(w.subjects || [])].filter(Boolean).join(' ');
            return (
              <div class="work-card group cursor-pointer px-1 pt-1 pb-0.5 rounded-lg border border-ink-700/30 bg-ink-800/20 hover:border-ink-600/50 hover:bg-ink-800/40 transition-colors"
                   data-work-card
                   data-idx={i}
                   data-category="islam"
                   data-title={searchText}
                   data-doc-id={w.doc_id}
                   data-sacred="0"
                   data-translated="0"
                   data-json={JSON.stringify({
                     ...w,
                     translated: false,
                   })}>
                <div class="flex items-start gap-1.5">
                  <svg viewBox="0 0 40 56" width="43" height="60" class="shrink-0 rounded-sm" style="width:43px;height:60px;" xmlns="http://www.w3.org/2000/svg"
                       role="img" aria-label={w.title}>
                    <rect width="40" height="56" rx="2" fill="#0f2518"/>
                    <rect x="0" y="0" width="2.5" height="56" fill="rgba(0,0,0,0.25)" rx="1"/>
                    <text x="21" y="28" text-anchor="middle" dominant-baseline="central"
                          font-family="'Scheherazade New',serif" font-size="14"
                          fill="#34d399" opacity="0.5">
                      {w.title_original ? w.title_original.charAt(0) : '\u0639'}
                    </text>
                  </svg>
                  <div class="min-w-0 flex-1">
                    <div class="flex items-center gap-1">
                      <span class="text-[11px] text-ink-200 leading-snug group-hover:text-ink-100 transition-colors truncate">
                        {w.sura_index}. {w.title}
                      </span>
                      <span class="flex-1"></span>
                      <span class={`shrink-0 text-[8px] uppercase tracking-wider px-1 py-px rounded ${w.subject === 'Meccan' ? 'text-amber-500/50 bg-amber-500/5' : 'text-sky-400/50 bg-sky-400/5'}`}>
                        {w.subject}
                      </span>
                    </div>
                    <div class="text-[10px] text-ink-400 italic leading-snug truncate">{w.title_english}</div>
                    <div class="card-bottom-row">
                      <div class="min-w-0 overflow-hidden text-left">
                        <span class="font-arabic text-[13px] text-ink-300 block truncate leading-relaxed">{w.title_original}</span>
                      </div>
                      <div class="shrink-0">
                        {w.est && (
                          <span class="text-[9px] font-mono text-ink-400 whitespace-nowrap">
                            ~<span class="text-emerald-400/80">{fmtCost(w.est.total)}</span>
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        <button class="show-more-btn w-full mt-3 py-1.5 text-xs text-ink-500 hover:text-ink-300 border border-ink-800/40 rounded-lg hover:border-ink-700/60 transition-colors"
                data-total="114">
          Show all 114
        </button>
      </section>
    </div>
  </div>

  <!-- Expansion panel template -->
  <template id="expand-tpl">
    <div class="expand-panel overflow-hidden transition-all duration-300 ease-out" style="max-height:0;opacity:0;">
      <div class="my-1.5 bg-ink-800/50 rounded-lg border border-ink-700/30 overflow-hidden">
        <!-- Clickable area linking to detail page -->
        <a data-slot="detail-link" class="block px-4 py-3 hover:bg-ink-700/30 transition-colors cursor-pointer" style="text-decoration:none;color:inherit;">
          <!-- Top row: cover + metadata side by side -->
          <div class="flex items-start gap-4 mb-2">
            <!-- Cover -->
            <div data-slot="large-thumb" class="shrink-0 hidden sm:block"></div>

            <!-- Right column: title, description, tags -->
            <div class="min-w-0 flex-1">
              <div class="flex items-start justify-between gap-2 mb-1">
                <div class="min-w-0">
                  <h3 class="text-base font-semibold text-ink-100" data-slot="title"></h3>
                  <div class="text-sm text-ink-400 italic" data-slot="title-english" style="display:none;"></div>
                  <div class="font-arabic text-ink-400 text-sm mt-0.5" dir="rtl" data-slot="title-orig"></div>
                </div>
                <button class="expand-close shrink-0 w-6 h-6 flex items-center justify-center rounded text-ink-500 hover:text-ink-200 hover:bg-ink-700/50 transition-colors" aria-label="Close">
                  <svg class="w-3 h-3" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4l8 8M12 4l-8 8"/></svg>
                </button>
              </div>

              <div data-slot="desc-wrap" class="hidden mb-1.5">
                <p class="text-[13px] text-ink-300 leading-relaxed" data-slot="description"></p>
              </div>

              <div class="flex flex-wrap items-center gap-1.5 mb-1.5">
                <div data-slot="best-known" class="hidden">
                  <span class="inline-flex items-center gap-1 text-[10px] text-gold-400 bg-gold-400/10 border border-gold-500/20 px-2 py-0.5 rounded-full">
                    &#9733; Best-Known Work
                  </span>
                </div>
                <span data-slot="tags" class="contents"></span>
              </div>

              <div data-slot="subjects-wrap" class="hidden mb-1">
                <div class="flex flex-wrap gap-1" data-slot="subjects"></div>
              </div>

              <div data-slot="bio-wrap" class="hidden mb-1 pl-3 border-l-2 border-ink-700/40">
                <p class="text-xs text-ink-500 italic leading-relaxed" data-slot="author-bio"></p>
              </div>
            </div>
          </div>

          <!-- Full-width: source text preview directly below cover -->
          <div class="manuscript" style="max-height:9.5rem;" data-slot="preview-wrap">
            <div class="manuscript-text text-sm leading-relaxed" style="line-height:1.8;color:rgba(226,173,68,0.55);" data-slot="preview"></div>
            <div class="manuscript-fade"></div>
          </div>
        </a>

        <!-- Sponsor button — full width -->
        <div class="px-4 py-3 border-t border-ink-700/30">
          <a data-slot="action-btn"
             class="block text-center py-3 font-mono bg-gold-400/10 border border-gold-500/40 text-gold-400 rounded-lg hover:bg-gold-400/20 transition-colors">
            <span class="text-sm" data-slot="action-label"></span>
            <span class="block text-[11px] text-ink-500 mt-0.5" data-slot="action-detail"></span>
          </a>
        </div>
      </div>
    </div>
  </template>

  <script is:inline>
    const tpl = document.getElementById('expand-tpl');
    let activePanel = null;
    let activeCard = null;

    function fmtCost(n) { return n < 1 ? Math.round(n * 100) + '\u00a2' : '$' + n.toFixed(0); }

    function buildLargeThumb(data) {
      if (data.cover_image) {
        return '<img src="https://18441963.imgix.net/ctai/' + data.doc_id + '.png?auto=format&fit=max&w=320" alt="' + (data.title || '') + '" width="160" height="224" style="width:160px;height:224px;" class="rounded object-cover"/>';
      }
      const isIslam = data.category === 'islam';
      const isSacred = (data.category || 'sacred') === 'sacred';
      const fill = isIslam ? '#0f2518' : isSacred ? '#2a1f15' : '#1a2030';
      const accent = isIslam ? '#34d399' : isSacred ? '#b8860b' : '#60a5fa';
      const ch = data.title_original ? data.title_original.charAt(0) : (data.language === 'ar' ? '\u0639' : '\u0641');
      const lines = (data.title_original || '').split(' ').slice(0, 3);
      let svg = '<svg viewBox="0 0 80 112" style="width:160px;height:224px;" class="rounded" xmlns="http://www.w3.org/2000/svg">';
      svg += '<rect width="80" height="112" rx="3" fill="' + fill + '"/>';
      svg += '<rect x="0" y="0" width="5" height="112" fill="rgba(0,0,0,0.3)" rx="2"/>';
      // Decorative line
      svg += '<line x1="12" y1="16" x2="72" y2="16" stroke="' + accent + '" stroke-opacity="0.2" stroke-width="0.5"/>';
      svg += '<line x1="12" y1="96" x2="72" y2="96" stroke="' + accent + '" stroke-opacity="0.2" stroke-width="0.5"/>';
      // Main character
      svg += '<text x="42" y="48" text-anchor="middle" dominant-baseline="central" font-family="\'Scheherazade New\',serif" font-size="28" fill="' + accent + '" opacity="0.5">' + ch + '</text>';
      // Title words in Arabic below
      lines.forEach(function(word, idx) {
        svg += '<text x="42" y="' + (68 + idx * 11) + '" text-anchor="middle" font-family="\'Scheherazade New\',serif" font-size="7" fill="' + accent + '" opacity="0.25">' + word + '</text>';
      });
      // Best-known ribbon
      if (data.is_best_known) {
        svg += '<polygon points="74,0 80,0 80,16 77,13 74,16" fill="#b8860b" opacity="0.7"/>';
      }
      svg += '</svg>';
      return svg;
    }

    document.addEventListener('click', function(e) {
      var card = e.target.closest('.work-card');
      if (!card) return;
      e.preventDefault();
      if (activeCard === card) { closePanel(); return; }

      var data = JSON.parse(card.dataset.json);

      if (activePanel) {
        activePanel.remove();
        activeCard && activeCard.classList.remove('ring-1', 'ring-gold-400/40', 'border-ink-700/40', 'bg-ink-800/30');
        activePanel = null;
        activeCard = null;
      }

      var panel = tpl.content.cloneNode(true).firstElementChild;

      // Title
      panel.querySelector('[data-slot="title"]').textContent = data.title;

      // English subtitle
      var engEl = panel.querySelector('[data-slot="title-english"]');
      if (data.title_english) {
        engEl.textContent = data.title_english;
        engEl.style.display = '';
      }

      // Original title
      var origEl = panel.querySelector('[data-slot="title-orig"]');
      if (data.title_original) origEl.textContent = data.title_original;
      else origEl.style.display = 'none';

      // Large thumbnail
      var thumbContainer = panel.querySelector('[data-slot="large-thumb"]');
      thumbContainer.innerHTML = buildLargeThumb(data);

      // Best-known badge
      if (data.is_best_known) {
        panel.querySelector('[data-slot="best-known"]').classList.remove('hidden');
      }

      // Description
      if (data.description) {
        panel.querySelector('[data-slot="desc-wrap"]').classList.remove('hidden');
        panel.querySelector('[data-slot="description"]').textContent = data.description;
      }

      // Subjects
      if (data.subjects && data.subjects.length) {
        panel.querySelector('[data-slot="subjects-wrap"]').classList.remove('hidden');
        var container = panel.querySelector('[data-slot="subjects"]');
        data.subjects.forEach(function(s) {
          var span = document.createElement('span');
          span.className = 'text-[10px] text-ink-400 bg-ink-700/50 px-2 py-0.5 rounded-full';
          span.textContent = s;
          container.appendChild(span);
        });
      }

      // Author bio
      if (data.author_bio) {
        panel.querySelector('[data-slot="bio-wrap"]').classList.remove('hidden');
        panel.querySelector('[data-slot="author-bio"]').textContent = data.author_bio;
      }

      // Meta tags
      var tagsEl = panel.querySelector('[data-slot="tags"]');
      var tags = [];
      tags.push({ text: data.language === 'ar' ? 'Arabic' : 'Persian', cls: 'text-ink-500 bg-ink-700' });
      if (data.word_count) tags.push({ text: data.word_count.toLocaleString() + ' words', cls: 'text-ink-500 font-mono' });
      if (data.se_translation) tags.push({ text: 'SE Corpus', cls: 'text-gold-400 bg-gold-400/10' });
      if (data.has_english_translation) tags.push({ text: 'Has English', cls: 'text-emerald-400 bg-emerald-400/10' });
      if (data.volume) tags.push({ text: 'Vol ' + data.volume + (data.volumes_total ? ' of ' + data.volumes_total : ''), cls: 'text-blue-400 bg-blue-400/10' });
      if (data.translation_style === 'modern') tags.push({ text: 'Modern style', cls: 'text-amber-400 bg-amber-400/10' });
      if (data.date_composed) tags.push({ text: data.date_composed, cls: 'text-ink-600' });
      tags.forEach(function(t) {
        var span = document.createElement('span');
        span.className = 'text-[10px] uppercase tracking-wider px-1.5 py-0.5 rounded ' + t.cls;
        span.textContent = t.text;
        tagsEl.appendChild(span);
      });

      // Preview
      if (data.source_preview) {
        panel.querySelector('[data-slot="preview"]').textContent = data.source_preview.slice(0, 300);
      } else {
        panel.querySelector('[data-slot="preview-wrap"]').style.display = 'none';
      }

      // Action button with cost detail inside
      var actionBtn = panel.querySelector('[data-slot="action-btn"]');
      var actionLabel = panel.querySelector('[data-slot="action-label"]');
      var actionDetail = panel.querySelector('[data-slot="action-detail"]');
      var isQuran = data.category === 'islam';
      var detailUrl = isQuran
        ? '/translations/quran/' + (data.sura_slug || data.doc_id) + '/'
        : '/translations/' + data.author_slug + '/' + data.doc_id + '/';
      actionBtn.href = detailUrl;
      if (isQuran) {
        actionLabel.textContent = data.est ? 'Sponsor Translation for ' + fmtCost(data.est.total) + ' \u2192' : 'Sponsor Translation \u2192';
        if (data.est) {
          actionDetail.textContent = '~' + data.est.paras + ' paras \u00b7 Seg ' + fmtCost(data.est.seg) + ' + Trans ' + fmtCost(data.est.trans);
        } else {
          actionDetail.style.display = 'none';
        }
        actionBtn.className = actionBtn.className.replace(/gold/g, 'emerald');
      } else if (data.translated) {
        actionLabel.textContent = 'Read Translation \u2192';
        actionDetail.style.display = 'none';
      } else {
        actionLabel.textContent = data.est ? 'Sponsor for ' + fmtCost(data.est.total) + ' \u2192' : 'Sponsor Translation \u2192';
        if (data.est) {
          actionDetail.textContent = '~' + data.est.paras + ' paras \u00b7 Seg ' + fmtCost(data.est.seg) + ' + Trans ' + fmtCost(data.est.trans);
        } else {
          actionDetail.style.display = 'none';
        }
      }

      // Detail page link (the whole card body)
      var detailLink = panel.querySelector('[data-slot="detail-link"]');
      detailLink.href = detailUrl;
      // Qur'an detail pages are internal now — no target="_blank"

      // Close button — stop link navigation and panel toggle
      panel.querySelector('.expand-close').addEventListener('click', function(ev) {
        ev.stopPropagation();
        ev.preventDefault();
        closePanel();
      });

      // Stop action btn clicks from bubbling to card toggle
      actionBtn.addEventListener('click', function(ev) { ev.stopPropagation(); });

      panel.style.gridColumn = '1 / -1';
      var parentGrid = card.closest('.grid');
      if (parentGrid) parentGrid.classList.remove('bookshelf-clamped');
      card.after(panel);
      activePanel = panel;
      activeCard = card;
      card.classList.add('ring-1', 'ring-gold-400/40', 'border-ink-700/40', 'bg-ink-800/30');

      requestAnimationFrame(function() {
        panel.style.maxHeight = panel.scrollHeight + 'px';
        panel.style.opacity = '1';
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    });

    function closePanel() {
      if (!activePanel) return;
      activePanel.style.maxHeight = '0';
      activePanel.style.opacity = '0';
      activeCard && activeCard.classList.remove('ring-1', 'ring-gold-400/40', 'border-ink-700/40', 'bg-ink-800/30');
      var section = activeCard && activeCard.closest('[data-author-section]');
      if (section) reclamp(section);
      var p = activePanel;
      setTimeout(function() { p.remove(); }, 300);
      activePanel = null;
      activeCard = null;
    }

    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closePanel(); });

    // Search
    document.getElementById('work-search').addEventListener('input', function(e) {
      var q = e.target.value.toLowerCase();
      closePanel();
      document.querySelectorAll('[data-work-card]').forEach(function(card) {
        card.style.display = (!q || card.dataset.title.toLowerCase().includes(q)) ? '' : 'none';
      });
      document.querySelectorAll('[data-author-section]').forEach(function(section) {
        var hasVisible = [].slice.call(section.querySelectorAll('[data-work-card]')).some(function(c) { return c.style.display !== 'none'; });
        section.style.display = hasVisible ? '' : 'none';
        var grid = section.querySelector('.grid');
        var btn = section.querySelector('.show-more-btn');
        if (q) {
          grid && grid.classList.remove('bookshelf-clamped');
          if (btn) btn.style.display = 'none';
        } else {
          reclamp(section);
        }
      });
    });

    // Category filter
    document.querySelectorAll('.filter-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        closePanel();
        var f = btn.dataset.filter;
        document.querySelectorAll('.filter-btn').forEach(function(b) {
          b.className = 'filter-btn px-2 py-0.5 text-[10px] font-mono uppercase tracking-wider rounded border border-ink-700/40 ' +
            (b === btn ? 'bg-ink-700 text-ink-200' : 'text-ink-500');
        });
        if (f === 'translated') {
          document.querySelectorAll('[data-author-section]').forEach(function(s) { s.style.display = ''; });
          document.querySelectorAll('[data-work-card]').forEach(function(c) {
            c.style.display = c.dataset.translated === '1' ? '' : 'none';
          });
          document.querySelectorAll('.grid').forEach(function(g) { g.classList.remove('bookshelf-clamped'); });
          document.querySelectorAll('.show-more-btn').forEach(function(b) { b.style.display = 'none'; });
        } else {
          document.querySelectorAll('[data-work-card]').forEach(function(c) { c.style.display = ''; });
          document.querySelectorAll('[data-author-section]').forEach(function(s) {
            s.style.display = (f === 'all' || s.dataset.category === f) ? '' : 'none';
          });
          document.querySelectorAll('[data-author-section]').forEach(function(s) { reclamp(s); });
        }
        document.querySelectorAll('[data-author-section]').forEach(function(s) {
          if (s.style.display !== 'none') {
            var hasVisible = [].slice.call(s.querySelectorAll('[data-work-card]')).some(function(c) { return c.style.display !== 'none'; });
            if (!hasVisible) s.style.display = 'none';
          }
        });
      });
    });

    // Show more/fewer
    document.querySelectorAll('.show-more-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var section = btn.closest('[data-author-section]');
        var grid = section.querySelector('.grid');
        var isClamped = grid.classList.contains('bookshelf-clamped');
        if (isClamped) {
          grid.classList.remove('bookshelf-clamped');
          btn.textContent = 'Show fewer';
        } else {
          closePanel();
          grid.classList.add('bookshelf-clamped');
          btn.textContent = 'Show all ' + btn.dataset.total;
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    function reclamp(section) {
      var btn = section.querySelector('.show-more-btn');
      if (!btn || btn.textContent === 'Show fewer') return;
      var grid = section.querySelector('.grid');
      grid && grid.classList.add('bookshelf-clamped');
      btn.style.display = '';
      btn.textContent = 'Show all ' + btn.dataset.total;
    }

  </script>

  <style>
    .bookshelf-clamped {
      /* Cards: ~66px per row (thumbnail 60px + pt-1 pb-0.5). 3 rows + 2 gaps. */
      max-height: 13rem;
      overflow: hidden;
    }
    .card-bottom-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: end;
      gap: 0.25rem;
      margin-top: 0;
    }
  </style>
</Base>
