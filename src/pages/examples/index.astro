---
import Base from '../../layouts/Base.astro';
import { coverUrl } from '../../lib/imgix.js';

// Load all _meta.json files via import.meta.glob (no fs needed â€” works in Workers)
const metaModules = import.meta.glob('/src/content/corpus/*/_meta.json', { eager: true, import: 'default' });
const coverModules = import.meta.glob('/covers/*.png', { eager: true, query: '?url', import: 'default' });

const works = Object.entries(metaModules)
  .map(([path, meta]) => {
    const slug = path.split('/').slice(-2, -1)[0];
    meta.hasCover = `/covers/${slug}.png` in coverModules;
    return meta;
  })
  .sort((a, b) => {
    const ya = parseInt(String(a.year_translated || '9999').match(/\d+/)?.[0] || '9999');
    const yb = parseInt(String(b.year_translated || '9999').match(/\d+/)?.[0] || '9999');
    return ya - yb;
  });

const totalPairs = works.reduce((sum, w) => sum + w.pair_count, 0);
const totalWords = works.reduce((sum, w) => sum + w.word_count, 0);

// Smart quotes for public-facing text
function curly(s) {
  if (!s) return s;
  s = s.replace(/"([^"]*?)"/g, '\u201c$1\u201d');
  s = s.replace(/(^|[\s(\u201c])'(?=\S)/gm, '$1\u2018');
  s = s.replace(/'/g, '\u2019');
  return s;
}

---

<Base title="Translations of Shoghi Effendi"
      description={`Browse ${works.length} works with ${totalPairs.toLocaleString()} parallel Arabic-English passages translated by Shoghi Effendi.`}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://ctai.org/" },
      { "@type": "ListItem", "position": 2, "name": "Examples" }
    ]
  })} />
  <h1 class="text-3xl md:text-4xl font-display font-bold italic text-ink-100 mb-1">Translations of Shoghi Effendi</h1>
  <p class="text-xl text-ink-400/80 font-display italic mb-6">A Divine Gift and Model for Translation</p>

  <div class="mb-12">
    <div class="float-right ml-8 mb-4 hidden md:block">
      <div class="relative">
        <img src="/shoghi-effendi-young.jpg" alt="Shoghi Effendi as a young child"
             width="208" height="270" class="w-52 rounded-lg shadow-xl sepia-[.3] brightness-90" />
        <p class="text-xs text-ink-600 mt-2 text-center italic">Shoghi Effendi as a child</p>
      </div>
    </div>
    <div class="text-base text-ink-400 leading-[1.8] max-w-3xl space-y-4">
      <p>
        As Guardian of the Bah&aacute;&rsquo;&iacute; Faith, Shoghi Effendi held the unique authority
        of divinely appointed interpreter. His English translations of
        Bah&aacute;&rsquo;u&rsquo;ll&aacute;h&rsquo;s writings are not merely linguistic
        renderings&thinsp;&mdash;&thinsp;they carry interpretive weight, embedding layers of meaning
        that reflect his authoritative understanding of the original Arabic and Persian texts.
      </p>
      <p>
        Shoghi Effendi described one purpose of his translations as being to
        <em>&ldquo;assist others&rdquo;</em> in the work of
        translation&thinsp;&mdash;&thinsp;effectively establishing an authoritative English vocabulary and
        stylistic standard that future translators could study and build upon. Each rendering
        of a term, each structural choice, serves as a guiding precedent.
      </p>
      <p class="text-base text-ink-500 font-mono clear-right">
        {totalPairs.toLocaleString()} parallel paragraphs &middot; {totalWords.toLocaleString()} words
        &middot; {works.length} works
      </p>
    </div>
  </div>

  <div class="space-y-6">
    {works.map((w, i) => {
      const coverLeft = i % 2 === 0;
      return (
        <>
          {i > 0 && (
            <div class="flex items-center gap-4 px-8">
              <div class="flex-1 h-px bg-gradient-to-r from-transparent via-ink-700/40 to-transparent" />
              <span class="text-ink-700 text-lg">&loz;</span>
              <div class="flex-1 h-px bg-gradient-to-r from-transparent via-ink-700/40 to-transparent" />
            </div>
          )}
          <a href={`/examples/${w.slug}/`}
             class="group block rounded-xl hover:bg-ink-800/30 transition-all p-4 md:p-6">
            <div class={`flex flex-col ${coverLeft ? 'md:flex-row' : 'md:flex-row-reverse'} gap-6 md:gap-10 items-start`}>
              {w.hasCover && (
                <div class="shrink-0 cover-perspective self-center md:self-start">
                  <img src={coverUrl(w.slug, { width: 352 })}
                       alt={`${w.title} book cover`}
                       loading="lazy" width="176" height="240"
                       class={`w-36 md:w-44 h-auto rounded-lg group-hover:scale-[1.03] transition-all duration-500
                               ${coverLeft ? 'cover-tilt-right' : 'cover-tilt-left'}`} />
                </div>
              )}
              <div class="flex-1 min-w-0">
                <h2 class="font-display text-2xl md:text-3xl font-bold italic text-ink-100 mb-2">{curly(w.title)}</h2>
                <p class="text-base text-ink-500 mb-3">
                  {curly(w.author)} &middot; Translated {w.year_translated}
                </p>
                {w.short_description && (
                  <p class="text-base text-ink-300/90 leading-[1.8] mb-4">{curly(w.short_description)}</p>
                )}
                <p class="text-sm text-ink-600">
                  {w.pair_count} paragraphs &middot; {w.word_count.toLocaleString()} words
                </p>
              </div>
            </div>
          </a>
        </>
      );
    })}
  </div>

  <style is:global>
    .cover-perspective {
      perspective: 800px;
    }
    .cover-tilt-right {
      transform: rotateY(-6deg);
      filter: drop-shadow(8px 12px 24px rgba(0, 0, 0, 0.5));
    }
    .cover-tilt-left {
      transform: rotateY(6deg);
      filter: drop-shadow(-8px 12px 24px rgba(0, 0, 0, 0.5));
    }
    .group:hover .cover-tilt-right,
    .group:hover .cover-tilt-left {
      transform: rotateY(0deg) scale(1.03);
      filter: drop-shadow(0 16px 32px rgba(0, 0, 0, 0.6));
    }
  </style>
</Base>
