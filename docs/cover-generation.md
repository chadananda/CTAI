# Cover Generation Pipeline

## Overview

Book covers are generated by Gemini AI (`scripts/generate-covers.js`) and stored in `covers/` (which is the same directory as `public/covers/` via hard link). All covers should have **transparent backgrounds** with the book's natural irregular edges visible.

## The Green-Screen Method

### Why This Method

Previous approaches all failed:

| Approach | Problem |
|----------|---------|
| Flood-fill from corners | Book leather edges blend gradually into background; can't find a clean boundary |
| Hue/brightness heuristics | Too many false positives (dark leather corners) and false negatives (similar-colored backgrounds) |
| AI background removal (`rembg`, `@imgly/background-removal-node`) | Models treat the uniform leather surface as "background" and strip it away |
| Gemini image editing (post-hoc) | Gemini regenerates the entire image when "editing" — edges come out different/unnatural |
| Gemini "extend leather to fill frame" | Produces clean rectangles with no natural book edges |

### What Works: Generate on Green, Then Chroma-Key

Generate the cover with a **solid bright magenta (#FF00FF) background** baked into the prompt. The book is born with natural edges against green, so no post-processing can damage them.

### Step 1: Prompt Structure

Add these elements to the generation prompt:

```
...photographed from directly above against a SOLID BRIGHT GREEN (#FF00FF) background.
The book should NOT fill the entire frame — show the complete book with its natural edges,
worn corners, and irregular leather boundaries visible against the green background.
Leave a visible margin of green around all edges of the book.
...
CRITICAL: The background behind the book must be SOLID PURE GREEN (#FF00FF) with absolutely
no variation, shadow, or gradient. The book's natural worn edges and corners should be
clearly visible against this green.
```

**Key prompt rules:**
- Do NOT ask for "edge to edge" or "no margins" — we WANT margins (green ones)
- Explicitly request worn corners, irregular edges, natural book shape
- Request pure #FF00FF with no shadows/gradients (cleaner chroma-key)

### Step 2: Chroma-Key (Magenta → Transparent)

After receiving the generated image, use **corner-sample + flood-fill + despill**:

1. **Sample** the average color from all four image corners (15x15 blocks)
2. **Flood-fill** from each corner, making pixels transparent if they're within `tolerance` color distance of the sampled background. The flood stops when it hits book-colored pixels.
3. **Despill** edge pixels: for opaque pixels adjacent to transparency, cap R and B channels to remove magenta tint while keeping the pixel fully opaque.

```javascript
// See chromaKeyAndTrim() in scripts/generate-covers.js for the full implementation
```

**Key parameters:**
- `tolerance = 120` — generous enough to catch shadows cast onto the magenta background, but magenta is so distinct from all book leather colors (brown, maroon, green, navy, cream) that this won't eat into the book.
- Despill threshold: `(r + b) / 2 - g > 30` detects magenta tint (high R+B, low G). Caps R and B to `g + 10`.

**Why magenta, not green?**
- Green backgrounds confuse with green leather (Qur'an covers, The Bab's works)
- Magenta (#FF00FF) doesn't appear in any author leather palette
- AI background removal models also fail because they treat uniform leather as "background"

### Step 3: Trim + Pad

Trim transparent margins, then add small padding so the irregular edges are visible:

```javascript
async function trimAndPad(pngBuffer, padding = 12) {
  const trimmed = await sharp(pngBuffer)
    .trim()
    .toBuffer({ resolveWithObject: true });

  return sharp(trimmed.data)
    .extend({
      top: padding, bottom: padding, left: padding, right: padding,
      background: { r: 0, g: 0, b: 0, alpha: 0 }
    })
    .png()
    .toBuffer();
}
```

**Why trim + pad?**
- `trim()` removes all transparent margins → book fills the bounding box
- Without padding, the worn edges touch the image boundary and the book looks rectangular
- 12px transparent padding lets the irregular edges breathe

### Full Pipeline

```javascript
// 1. Generate with green background prompt
const rawBuffer = await generateWithGemini(greenPrompt);

// 2. Chroma-key green → transparent + despill edges
const keyed = await chromaKey(rawBuffer);

// 3. Trim transparent margins + add padding
const final = await trimAndPad(keyed, 12);

// 4. Save
writeFileSync(outputPath, final);
```

## Common Pitfalls

1. **DO NOT use "edge to edge" in prompts** when you want transparent backgrounds. That produces rectangular covers with no natural edges.

2. **DO NOT use AI background removal tools** (rembg, @imgly/background-removal-node) on book covers. They classify leather as background.

3. **DO NOT try to edit existing covers** to remove backgrounds. Gemini regenerates the entire image on "edit", producing different/unnatural edges.

4. **DO NOT make edge pixels transparent** during chroma-key. Despill them (remove green tint) but keep them fully opaque. Making edges transparent creates damaged-looking borders.

5. **DO NOT use post-hoc flood-fill or color-distance approaches.** Book leather edges blend gradually into backgrounds — there is no clean color boundary to detect.

## Model

Current model: `gemini-3-pro-image-preview` with `responseModalities: ['TEXT', 'IMAGE']` and `imageConfig: { aspectRatio: '3:4' }`.

## Files

- `scripts/generate-covers.js` — main generation script
- `covers/` = `public/covers/` — output directory (same inode, not git-tracked)
- `src/content/works/{author}/*.json` — work metadata including `cover_description`
