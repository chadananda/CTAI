---
export const prerender = false;
import Base from '../layouts/Base.astro';
import { getCollection } from 'astro:content';
const allWorks = await getCollection('works');

// Pre-compute costs using DEFAULT_MODEL from cost-estimator
const CHARS_PER_WORD = { ar: 4.5, fa: 5 };
const CHARS_PER_PARA = { ar: 400, fa: 450 };
const COST_PER_PARA = { seg: 0.20, research: 0.05, trans: 0.75, assembly: 0.05 };
const CUSHION = 1.5;
const TOTAL_PER_PARA = (COST_PER_PARA.seg + COST_PER_PARA.research + COST_PER_PARA.trans + COST_PER_PARA.assembly) * CUSHION;

function estimateCost(w) {
  if (!w.word_count) return null;
  const lang = w.language || 'ar';
  const chars = w.word_count * (CHARS_PER_WORD[lang] || 4.5);
  const paras = Math.max(1, Math.ceil(chars / (CHARS_PER_PARA[lang] || 400)));
  const seg = Math.round(paras * COST_PER_PARA.seg * CUSHION * 100) / 100;
  const trans = Math.round(paras * (COST_PER_PARA.research + COST_PER_PARA.trans + COST_PER_PARA.assembly) * CUSHION * 100) / 100;
  const total = Math.round(paras * TOTAL_PER_PARA * 100) / 100;
  return { paras, seg, trans, total };
}

function fmtCost(n) { return n < 1 ? `${Math.round(n * 100)}¢` : `$${n.toFixed(0)}`; }
function fmtSize(n) {
  if (!n) return '?';
  if (n >= 1000) return `${(n / 1000).toFixed(n >= 10000 ? 0 : 1)}k`;
  return String(n);
}

const byAuthor = new Map();
for (const entry of allWorks) {
  const author = entry.data.author;
  if (!byAuthor.has(author)) byAuthor.set(author, []);
  byAuthor.get(author).push({ ...entry.data, est: estimateCost(entry.data) });
}
const sacredOrder = ["Baha'u'llah", "The Bab", "Abdu'l-Baha", "Shoghi Effendi"];
const sortedAuthors = [...byAuthor.keys()].sort((a, b) => {
  const ai = sacredOrder.indexOf(a);
  const bi = sacredOrder.indexOf(b);
  return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
});
const totalWorks = allWorks.length;
const sacredCount = allWorks.filter(w => w.data.category === 'sacred').length;
const scholarlyCount = allWorks.filter(w => w.data.category === 'scholarly').length;
---

<Base title="Translate" description={`Browse ${totalWorks} works awaiting committee translation.`}>
  <div class="mb-6">
    <h1 class="text-2xl font-semibold text-ink-100 mb-2">Translation Catalog</h1>
    <p class="text-ink-400 text-sm leading-relaxed max-w-3xl mb-1">
      These are <span class="text-ink-200">{totalWorks}</span> tablets, prayers, and scholarly works in Arabic and Persian
      that I would love to see translated into English using our committee translation system &mdash;
      three AI translators deliberating in rounds, guided by Shoghi Effendi&rsquo;s concordance.
    </p>
    <p class="text-ink-500 text-sm leading-relaxed max-w-3xl mb-4">
      Each translation costs real money in AI processing. If you <span class="text-gold-400">sponsor a translation</span>,
      the result is published here for everyone &mdash; a permanent gift to the community.
    </p>
    <div class="flex flex-wrap gap-3 items-center">
      <input type="search" id="work-search" placeholder="Search by title..."
        class="w-52 px-2.5 py-1 text-xs bg-ink-800/60 border border-ink-700/40 rounded text-ink-300 placeholder:text-ink-600 focus:border-gold-500/40 focus:outline-none"/>
      <div class="flex gap-1">
        <button data-filter="all" class="filter-btn px-2 py-0.5 text-[9px] font-mono uppercase tracking-wider rounded border border-ink-700/40 bg-ink-700 text-ink-200">All ({totalWorks})</button>
        <button data-filter="sacred" class="filter-btn px-2 py-0.5 text-[9px] font-mono uppercase tracking-wider rounded border border-ink-700/40 text-ink-500">Sacred ({sacredCount})</button>
        <button data-filter="scholarly" class="filter-btn px-2 py-0.5 text-[9px] font-mono uppercase tracking-wider rounded border border-ink-700/40 text-ink-500">Scholarly ({scholarlyCount})</button>
        <button data-filter="translated" class="filter-btn px-2 py-0.5 text-[9px] font-mono uppercase tracking-wider rounded border border-ink-700/40 text-ink-500 text-emerald-500/60">Translated</button>
      </div>
    </div>
  </div>

  {sortedAuthors.map(author => {
    const works = byAuthor.get(author).sort((a, b) => a.title.localeCompare(b.title));
    const category = works[0].category || 'sacred';
    const isSacred = category === 'sacred';
    return (
      <section class="mb-8" data-author-section data-category={category}>
        <div class="flex items-baseline gap-2 mb-2 border-b border-ink-800/60 pb-1.5">
          <h2 class="text-sm font-semibold text-ink-300">{author}</h2>
          <span class="text-[9px] text-ink-600 font-mono">{works.length}</span>
          {!isSacred && <span class="text-[8px] uppercase tracking-wider text-blue-400/50 bg-blue-400/5 px-1 py-0.5 rounded">Scholarly</span>}
        </div>
        <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-2">
          {works.map(w => {
            const isTranslated = w.translation_status === 'complete';
            const origChar = w.title_original ? w.title_original.charAt(0) : '';
            return (
              <div class="work-card cursor-pointer"
                   data-work-card
                   data-category={w.category || 'sacred'}
                   data-title={`${w.title} ${w.title_original || ''} ${w.subject || ''}`}
                   data-doc-id={w.doc_id}
                   data-author-slug={w.author_slug}
                   data-sacred={isSacred ? '1' : '0'}
                   data-translated={isTranslated ? '1' : '0'}
                   data-json={JSON.stringify({
                     title: w.title,
                     title_original: w.title_original,
                     author: w.author,
                     author_slug: w.author_slug,
                     doc_id: w.doc_id,
                     language: w.language,
                     category: w.category,
                     subject: w.subject,
                     word_count: w.word_count,
                     source_preview: w.source_preview,
                     source_url: w.source_url,
                     se_translation: w.se_translation,
                     has_english_translation: w.has_english_translation,
                     volume: w.volume,
                     volumes_total: w.volumes_total,
                     date_composed: w.date_composed,
                     translation_style: w.translation_style,
                     author_original: w.author_original,
                     est: w.est,
                     translated: isTranslated,
                   })}>
                {/* Book cover */}
                {isSacred ? (
                  <svg viewBox="0 0 60 84" class="w-full rounded-sm shadow shadow-black/40 hover:shadow-gold-400/10 transition-shadow" xmlns="http://www.w3.org/2000/svg">
                    <rect width="60" height="84" rx="1" fill="#2a1f15"/>
                    <rect x="0" y="0" width="3" height="84" fill="rgba(0,0,0,0.3)" rx="1"/>
                    <rect x="5" y="6" width="50" height="72" rx="0.5" fill="none" stroke="#b8860b" stroke-width="0.4" opacity="0.4"/>
                    <g opacity="0.3" stroke="#b8860b" stroke-width="0.3" fill="none">
                      <path d="M8,9 L13,9 M8,9 L8,14"/><path d="M52,9 L47,9 M52,9 L52,14"/>
                      <path d="M8,75 L13,75 M8,75 L8,70"/><path d="M52,75 L47,75 M52,75 L52,70"/>
                    </g>
                    {origChar && (
                      <text x="30" y="36" text-anchor="middle" dominant-baseline="central"
                            font-family="'Scheherazade New', serif" font-size="12"
                            fill="#b8860b" opacity="0.5">{origChar}</text>
                    )}
                    <foreignObject x="6" y="46" width="48" height="28">
                      <div xmlns="http://www.w3.org/1999/xhtml"
                           style="font-family:'EB Garamond',serif;font-size:5px;color:#b8860b;text-align:center;line-height:1.2;overflow:hidden;opacity:0.6;">
                        {w.title.length > 30 ? w.title.slice(0, 28) + '..' : w.title}
                      </div>
                    </foreignObject>
                    {isTranslated && <rect x="0" y="0" width="60" height="84" rx="1" fill="rgba(16,185,129,0.12)"/>}
                  </svg>
                ) : (
                  <svg viewBox="0 0 60 84" class="w-full rounded-sm shadow shadow-black/40 hover:shadow-blue-400/10 transition-shadow" xmlns="http://www.w3.org/2000/svg">
                    <rect width="60" height="84" rx="1" fill="#1a2030"/>
                    <rect x="0" y="0" width="3" height="84" fill="rgba(0,0,0,0.25)" rx="1"/>
                    {[18,26,34,42,50,58,66].map(y => <line x1="7" y1={y} x2="55" y2={y} stroke="#334155" stroke-width="0.2" opacity="0.4"/>)}
                    <line x1="11" y1="5" x2="11" y2="79" stroke="#ef444480" stroke-width="0.2"/>
                    <rect x="4" y="5" width="52" height="9" rx="0.5" fill="rgba(96,165,250,0.08)"/>
                    <foreignObject x="6" y="5" width="48" height="9">
                      <div xmlns="http://www.w3.org/1999/xhtml"
                           style="font-family:'JetBrains Mono',monospace;font-size:3.5px;color:#93c5fd;text-align:center;line-height:9px;overflow:hidden;white-space:nowrap;">
                        {w.title.length > 20 ? w.title.slice(0, 18) + '..' : w.title}
                      </div>
                    </foreignObject>
                    {w.volume && (
                      <text x="48" y="78" text-anchor="middle" font-family="monospace" font-size="4" fill="#60a5fa" opacity="0.5">v{w.volume}</text>
                    )}
                  </svg>
                )}
                {/* Below cover: size + cost */}
                <div class="mt-1 px-0.5">
                  <div class="text-[10px] text-ink-300 leading-tight line-clamp-1">{w.title}</div>
                  <div class="flex items-center gap-1 mt-0.5">
                    <span class="text-[8px] font-mono text-ink-600">{fmtSize(w.word_count)}w</span>
                    {w.est && <span class="text-[8px] font-mono text-gold-500/60">{fmtCost(w.est.total)}</span>}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
        {/* Expansion panel — injected via JS after the grid */}
      </section>
    );
  })}

  <!-- Expansion panel template (cloned by JS) -->
  <template id="expand-tpl">
    <div class="expand-panel overflow-hidden transition-all duration-300 ease-out" style="max-height:0;opacity:0;">
      <div class="p-4 my-2 bg-ink-800/60 rounded-lg border border-ink-700/40 backdrop-blur-sm">
        <div class="flex gap-5">
          {/* Cover */}
          <div class="shrink-0 w-24" data-slot="cover"></div>
          {/* Content */}
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-3 mb-2">
              <div>
                <h3 class="text-base font-semibold text-ink-100" data-slot="title"></h3>
                <div class="font-arabic text-ink-400 text-sm mt-0.5" dir="rtl" data-slot="title-orig"></div>
              </div>
              <button class="expand-close shrink-0 w-6 h-6 flex items-center justify-center rounded text-ink-500 hover:text-ink-200 hover:bg-ink-700/50 transition-colors" aria-label="Close">
                <svg class="w-3.5 h-3.5" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4l8 8M12 4l-8 8"/></svg>
              </button>
            </div>
            <div class="text-xs text-ink-400 mb-3" data-slot="subject"></div>
            {/* Tags */}
            <div class="flex flex-wrap gap-1.5 mb-3" data-slot="tags"></div>
            {/* Cost breakdown */}
            <div class="flex flex-wrap gap-4 mb-3 text-[11px]" data-slot="costs">
              <div><span class="text-ink-500">Segmentation</span> <span class="font-mono text-ink-300" data-slot="cost-seg"></span></div>
              <div><span class="text-ink-500">Translation</span> <span class="font-mono text-ink-300" data-slot="cost-trans"></span></div>
              <div><span class="text-ink-500">Total</span> <span class="font-mono text-gold-400" data-slot="cost-total"></span></div>
              <div><span class="text-ink-600 font-mono" data-slot="cost-paras"></span></div>
            </div>
            {/* Source preview */}
            <div class="manuscript mb-3" style="max-height:100px;" data-slot="preview-wrap">
              <div class="manuscript-text text-xs leading-relaxed" style="line-height:1.8;" data-slot="preview"></div>
              <div class="manuscript-fade"></div>
            </div>
            {/* Actions */}
            <div class="flex items-center gap-3">
              <a data-slot="action-btn"
                 class="inline-flex items-center gap-1.5 px-4 py-2 text-xs font-mono bg-gold-400/10 border border-gold-500/40 text-gold-400 rounded-lg hover:bg-gold-400/20 transition-colors">
              </a>
              <a data-slot="source-link" target="_blank" rel="noopener"
                 class="text-xs text-ink-500 hover:text-ink-300 hidden"></a>
              <a data-slot="detail-link" class="text-xs text-ink-600 hover:text-ink-400"></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script is:inline>
    const tpl = document.getElementById('expand-tpl');
    let activePanel = null;
    let activeCard = null;

    function fmtCost(n) { return n < 1 ? Math.round(n * 100) + '¢' : '$' + n.toFixed(0); }

    // Click handler for cards
    document.addEventListener('click', (e) => {
      const card = e.target.closest('.work-card');
      if (!card) return;
      e.preventDefault();

      // If clicking same card, close it
      if (activeCard === card) {
        closePanel();
        return;
      }

      const data = JSON.parse(card.dataset.json);
      const section = card.closest('[data-author-section]');
      const grid = section.querySelector('.grid');
      const isSacred = card.dataset.sacred === '1';

      // Close existing panel
      if (activePanel) {
        activePanel.remove();
        activeCard?.classList.remove('ring-1', 'ring-gold-400/40');
        activePanel = null;
        activeCard = null;
      }

      // Create panel from template
      const panel = tpl.content.cloneNode(true).firstElementChild;

      // Fill slots
      panel.querySelector('[data-slot="title"]').textContent = data.title;
      const origEl = panel.querySelector('[data-slot="title-orig"]');
      if (data.title_original) origEl.textContent = data.title_original;
      else origEl.style.display = 'none';

      const subEl = panel.querySelector('[data-slot="subject"]');
      if (data.subject) subEl.textContent = data.subject;
      else subEl.style.display = 'none';

      // Tags
      const tagsEl = panel.querySelector('[data-slot="tags"]');
      const tags = [];
      tags.push({ text: data.language === 'ar' ? 'Arabic' : 'Persian', cls: 'text-ink-500 bg-ink-700' });
      if (data.word_count) tags.push({ text: data.word_count.toLocaleString() + ' words', cls: 'text-ink-500 font-mono' });
      if (data.se_translation) tags.push({ text: 'SE Corpus', cls: 'text-gold-400 bg-gold-400/10' });
      if (data.has_english_translation) tags.push({ text: 'Has English', cls: 'text-emerald-400 bg-emerald-400/10' });
      if (data.volume) tags.push({ text: 'Vol ' + data.volume + (data.volumes_total ? ' of ' + data.volumes_total : ''), cls: 'text-blue-400 bg-blue-400/10' });
      if (data.translation_style === 'modern') tags.push({ text: 'Modern style', cls: 'text-amber-400 bg-amber-400/10' });
      if (data.date_composed) tags.push({ text: data.date_composed, cls: 'text-ink-600' });
      tags.forEach(t => {
        const span = document.createElement('span');
        span.className = 'text-[10px] uppercase tracking-wider px-1.5 py-0.5 rounded ' + t.cls;
        span.textContent = t.text;
        tagsEl.appendChild(span);
      });

      // Costs
      const costsEl = panel.querySelector('[data-slot="costs"]');
      if (data.est) {
        panel.querySelector('[data-slot="cost-seg"]').textContent = fmtCost(data.est.seg);
        panel.querySelector('[data-slot="cost-trans"]').textContent = fmtCost(data.est.trans);
        panel.querySelector('[data-slot="cost-total"]').textContent = fmtCost(data.est.total);
        panel.querySelector('[data-slot="cost-paras"]').textContent = '~' + data.est.paras + ' paras';
      } else {
        costsEl.style.display = 'none';
      }

      // Preview
      const previewWrap = panel.querySelector('[data-slot="preview-wrap"]');
      if (data.source_preview) {
        panel.querySelector('[data-slot="preview"]').textContent = data.source_preview.slice(0, 300);
      } else {
        previewWrap.style.display = 'none';
      }

      // Cover (simplified mini version)
      const coverEl = panel.querySelector('[data-slot="cover"]');
      const origChar = data.title_original ? data.title_original.charAt(0) : '';
      if (isSacred) {
        coverEl.innerHTML = `<svg viewBox="0 0 120 170" class="w-full rounded shadow-md" xmlns="http://www.w3.org/2000/svg">
          <rect width="120" height="170" rx="2" fill="#2a1f15"/>
          <rect x="0" y="0" width="6" height="170" fill="rgba(0,0,0,0.3)" rx="2"/>
          <rect x="10" y="12" width="100" height="146" rx="1" fill="none" stroke="#b8860b" stroke-width="0.5" opacity="0.4"/>
          <g opacity="0.3" stroke="#b8860b" stroke-width="0.5" fill="none">
            <path d="M16,18 L26,18 M16,18 L16,28"/><path d="M104,18 L94,18 M104,18 L104,28"/>
            <path d="M16,152 L26,152 M16,152 L16,142"/><path d="M104,152 L94,152 M104,152 L104,142"/>
          </g>
          ${origChar ? `<text x="60" y="75" text-anchor="middle" font-family="'Scheherazade New',serif" font-size="28" fill="#b8860b" opacity="0.5">${origChar}</text>` : ''}
          <text x="60" y="162" text-anchor="middle" font-family="monospace" font-size="5" fill="#b8860b" opacity="0.35">${data.language === 'ar' ? 'ARABIC' : 'PERSIAN'}</text>
        </svg>`;
      } else {
        coverEl.innerHTML = `<svg viewBox="0 0 120 170" class="w-full rounded shadow-md" xmlns="http://www.w3.org/2000/svg">
          <rect width="120" height="170" rx="2" fill="#1a2030"/>
          <rect x="0" y="0" width="6" height="170" fill="rgba(0,0,0,0.25)" rx="2"/>
          ${[40,55,70,85,100,115,130].map(y => `<line x1="14" y1="${y}" x2="112" y2="${y}" stroke="#334155" stroke-width="0.3" opacity="0.4"/>`).join('')}
          <line x1="22" y1="10" x2="22" y2="160" stroke="#ef444480" stroke-width="0.3"/>
          ${data.author_original ? `<text x="60" y="90" text-anchor="middle" font-family="'Scheherazade New',serif" font-size="12" fill="#475569" opacity="0.5" direction="rtl">${data.author_original}</text>` : ''}
          <text x="60" y="162" text-anchor="middle" font-family="monospace" font-size="5" fill="#475569" opacity="0.4">PERSIAN</text>
        </svg>`;
      }

      // Action button
      const actionBtn = panel.querySelector('[data-slot="action-btn"]');
      if (data.translated) {
        actionBtn.textContent = 'Read Translation →';
        actionBtn.href = '/translations/' + data.author_slug + '/' + data.doc_id + '/';
      } else {
        actionBtn.textContent = data.est ? 'Translate for ' + fmtCost(data.est.total) + ' →' : 'Translate →';
        actionBtn.href = '/translations/' + data.author_slug + '/' + data.doc_id + '/';
      }

      // Source link
      const srcLink = panel.querySelector('[data-slot="source-link"]');
      if (data.source_url) {
        srcLink.href = data.source_url;
        srcLink.textContent = 'Source ↗';
        srcLink.classList.remove('hidden');
      }

      // Detail link
      const detLink = panel.querySelector('[data-slot="detail-link"]');
      detLink.href = '/translations/' + data.author_slug + '/' + data.doc_id + '/';
      detLink.textContent = 'Full details →';

      // Close button
      panel.querySelector('.expand-close').addEventListener('click', (e) => {
        e.stopPropagation();
        closePanel();
      });

      // Insert after grid
      grid.after(panel);
      activePanel = panel;
      activeCard = card;
      card.classList.add('ring-1', 'ring-gold-400/40');

      // Animate open
      requestAnimationFrame(() => {
        panel.style.maxHeight = panel.scrollHeight + 'px';
        panel.style.opacity = '1';
        // Scroll into view
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    });

    function closePanel() {
      if (!activePanel) return;
      activePanel.style.maxHeight = '0';
      activePanel.style.opacity = '0';
      activeCard?.classList.remove('ring-1', 'ring-gold-400/40');
      const p = activePanel;
      setTimeout(() => p.remove(), 300);
      activePanel = null;
      activeCard = null;
    }

    // ESC to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePanel();
    });

    // Search
    document.getElementById('work-search')?.addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      closePanel();
      document.querySelectorAll('[data-work-card]').forEach(card => {
        card.style.display = card.dataset.title.toLowerCase().includes(q) ? '' : 'none';
      });
      document.querySelectorAll('[data-author-section]').forEach(section => {
        section.style.display = section.querySelectorAll('[data-work-card]:not([style*="display: none"])').length ? '' : 'none';
      });
    });

    // Category filter
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        closePanel();
        const f = btn.dataset.filter;
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.toggle('bg-ink-700', b === btn);
          b.classList.toggle('text-ink-200', b === btn);
          b.classList.toggle('text-ink-500', b !== btn);
        });
        if (f === 'translated') {
          // Show only translated cards, hide untranslated
          document.querySelectorAll('[data-author-section]').forEach(s => s.style.display = '');
          document.querySelectorAll('[data-work-card]').forEach(c => {
            c.style.display = c.dataset.translated === '1' ? '' : 'none';
          });
          document.querySelectorAll('[data-author-section]').forEach(s => {
            s.style.display = s.querySelectorAll('[data-work-card]:not([style*="display: none"])').length ? '' : 'none';
          });
        } else {
          // Reset card visibility, filter sections
          document.querySelectorAll('[data-work-card]').forEach(c => c.style.display = '');
          document.querySelectorAll('[data-author-section]').forEach(s => {
            s.style.display = (f === 'all' || s.dataset.category === f) ? '' : 'none';
          });
        }
      });
    });
  </script>
</Base>
