---
import Corpus from '../../../layouts/Corpus.astro';
import TermAnnotation from '../../../components/TermAnnotation.svelte';
import CrossRefLinks from '../../../components/CrossRefLinks.svelte';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const corpusDir = path.resolve('src/content/corpus');
  const slugs = fs.readdirSync(corpusDir).filter(d =>
    fs.statSync(path.join(corpusDir, d)).isDirectory()
  );

  const paths = [];
  for (const slug of slugs) {
    const dir = path.join(corpusDir, slug);
    const metaPath = path.join(dir, '_meta.json');
    const meta = fs.existsSync(metaPath) ? JSON.parse(fs.readFileSync(metaPath, 'utf-8')) : { title: slug, pair_count: 0 };

    const paraFiles = fs.readdirSync(dir)
      .filter(f => f !== '_meta.json' && f.endsWith('.json'));

    for (const file of paraFiles) {
      const data = JSON.parse(fs.readFileSync(path.join(dir, file), 'utf-8'));
      paths.push({
        params: { work: slug, para: String(data.pair_index) },
        props: { paragraph: data, meta, totalParas: meta.pair_count },
      });
    }
  }
  return paths;
}

const { work, para } = Astro.params;
const { paragraph, meta, totalParas } = Astro.props;
const p = paragraph;
---

<Corpus
  title={`${meta.title} — §${p.pair_index}`}
  work={meta.title}
  workSlug={work}
  paraIndex={p.pair_index}
  totalParas={totalParas}
>
  <h1 class="text-2xl font-semibold text-stone-800 mb-6">
    {meta.title} — Paragraph {p.pair_index}
  </h1>

  <!-- Side-by-side source + translation -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
    <div class="bg-white rounded-lg border border-stone-200 p-6">
      <h2 class="text-xs uppercase tracking-wider text-stone-400 mb-3">
        Source ({p.source_lang === 'ar' ? 'Arabic' : 'Persian'})
      </h2>
      <div dir="rtl" class="font-arabic text-xl leading-loose text-stone-800 text-right">
        {p.source_text}
      </div>
    </div>

    <div class="bg-white rounded-lg border border-stone-200 p-6">
      <h2 class="text-xs uppercase tracking-wider text-stone-400 mb-3">Translation</h2>
      <div class="text-lg leading-relaxed text-stone-800">
        {p.translation}
      </div>
    </div>
  </div>

  <!-- Term annotations (populated by build-annotations.js) -->
  {p.terms && p.terms.length > 0 && (
    <section class="mb-10">
      <h2 class="text-sm font-semibold text-stone-600 uppercase tracking-wider mb-4">
        Translation Notes
      </h2>
      <div class="space-y-3">
        {p.terms.map(term => (
          <TermAnnotation term={term} client:visible />
        ))}
      </div>
    </section>
  )}

  <!-- Cross-references -->
  {p.terms && p.terms.length > 0 && (
    <CrossRefLinks terms={p.terms} client:visible />
  )}

  <!-- Source attribution -->
  <footer class="mt-10 pt-6 border-t border-stone-200 text-sm text-stone-500">
    <p>
      Source: {p.author}, <em>{meta.title}</em>
      {meta.source_url && (
        <span>
          &middot;
          <a href={meta.source_url} target="_blank" rel="noopener noreferrer"
             class="text-gold-700 hover:text-gold-900 underline underline-offset-2">
            View original
          </a>
        </span>
      )}
    </p>
  </footer>
</Corpus>
