---
import Base from '../../../layouts/Base.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allWorks = await getCollection('works');
  return allWorks.map(entry => ({
    params: { author: entry.data.author_slug, work: entry.data.doc_id },
    props: { work: entry.data },
  }));
}

import { estimateCost, fmtCost } from '../../../lib/cost-estimate.js';

const { work } = Astro.props;
const isTranslated = work.translation_status === 'complete';
const langName = work.language === 'ar' ? 'Arabic' : work.language === 'fa' ? 'Persian' : work.language;
const est = estimateCost(work);

// Author color theming (matches model pages)
const authorColors = {
  bahaullah:    { bg: 'bg-rose-950/30', border: 'border-rose-800/30', accent: 'text-rose-300', badge: 'bg-rose-900/40 text-rose-300' },
  'the-bab':    { bg: 'bg-emerald-950/30', border: 'border-emerald-800/30', accent: 'text-emerald-300', badge: 'bg-emerald-900/40 text-emerald-300' },
  'abdul-baha': { bg: 'bg-blue-950/30', border: 'border-blue-800/30', accent: 'text-blue-300', badge: 'bg-blue-900/40 text-blue-300' },
};
const colors = authorColors[work.author_slug] || { bg: 'bg-ink-800/30', border: 'border-ink-700/40', accent: 'text-gold-300', badge: 'bg-ink-700/60 text-ink-300' };
---

<Base title={work.title} description={work.description || `${work.title} — ${isTranslated ? 'Committee translation' : 'Awaiting committee translation'} from ${langName}`}>
  <nav class="flex items-center gap-3 text-sm text-ink-500 mb-6">
    <a href="/translations/" class="hover:text-ink-200">Translations</a>
    <span class="text-ink-700">/</span>
    <a href={`/translations/${work.author_slug}/`} class="hover:text-ink-200">{work.author}</a>
    <span class="text-ink-700">/</span>
    <span class="text-ink-200">{work.title}</span>
  </nav>

  <!-- Hero / Introduction -->
  <header class={`rounded-xl ${colors.bg} ${colors.border} border p-8 mb-10`}>
    <div class="float-right ml-6 mb-4 hero-cover-wrapper">
      {work.cover_image ? (
        <img src={work.cover_image} alt={work.title}
             width="224" height="310"
             class="hero-cover w-48 md:w-56" />
      ) : (
        <svg viewBox="0 0 160 224" class="hero-cover w-48 md:w-56" xmlns="http://www.w3.org/2000/svg" role="img" aria-label={work.title}>
          <rect width="160" height="224" rx="6" fill={work.category === 'sacred' ? '#2a1f15' : '#1a2030'} />
          <rect x="0" y="0" width="10" height="224" fill="rgba(0,0,0,0.3)" rx="3" />
          <line x1="24" y1="32" x2="144" y2="32" stroke={work.category === 'sacred' ? '#b8860b' : '#60a5fa'} stroke-opacity="0.2" stroke-width="0.5" />
          <line x1="24" y1="192" x2="144" y2="192" stroke={work.category === 'sacred' ? '#b8860b' : '#60a5fa'} stroke-opacity="0.2" stroke-width="0.5" />
          <text x="84" y="100" text-anchor="middle" dominant-baseline="central"
                font-family="'Scheherazade New',serif" font-size="56"
                fill={work.category === 'sacred' ? '#b8860b' : '#60a5fa'} opacity="0.5">
            {work.title_original ? work.title_original.charAt(0) : (work.language === 'ar' ? '\u0639' : '\u0641')}
          </text>
          {work.title_original && work.title_original.split(' ').slice(0, 3).map((word, i) => (
            <text x="84" y={140 + i * 18} text-anchor="middle"
                  font-family="'Scheherazade New',serif" font-size="12"
                  fill={work.category === 'sacred' ? '#b8860b' : '#60a5fa'} opacity="0.25">
              {word}
            </text>
          ))}
          {work.is_best_known && (
            <polygon points="146,0 160,0 160,32 153,26 146,32" fill="#b8860b" opacity="0.7" />
          )}
        </svg>
      )}
    </div>

    <h1 class="text-3xl md:text-4xl font-display font-bold italic text-ink-100 mb-1">{work.title}</h1>
    {work.title_english && (
      <p class="text-lg text-ink-400 italic mb-1">{work.title_english}</p>
    )}
    {work.title_original && (
      <p class="font-arabic text-2xl text-ink-400 text-left mb-3">{work.title_original}</p>
    )}
    <p class="text-ink-400 mb-4">{work.author}</p>

    <div class="flex flex-wrap gap-2 text-xs font-mono mb-5">
      <span class={`px-2.5 py-1 rounded ${colors.badge}`}>{langName}</span>
      {work.word_count && <span class={`px-2.5 py-1 rounded ${colors.badge}`}>{work.word_count.toLocaleString()} words</span>}
      {work.is_best_known && <span class="px-2.5 py-1 rounded bg-gold-500/10 text-gold-400">Best-Known Work</span>}
      {work.se_translation && <span class="px-2.5 py-1 rounded bg-gold-500/10 text-gold-400">SE Corpus</span>}
      {isTranslated ? (
        <span class="px-2.5 py-1 rounded bg-emerald-900/40 text-emerald-300">Translation Complete</span>
      ) : (
        <span class="px-2.5 py-1 rounded bg-ink-700/60 text-ink-400">Awaiting Translation</span>
      )}
    </div>

    {work.description && (
      <div class="border-l-2 border-ink-600/30 pl-5">
        <p class="text-[15px] text-ink-300/90 leading-[1.75] tracking-wide">{work.description}</p>
      </div>
    )}
  </header>

  {/* Subjects */}
  {work.subjects && work.subjects.length > 0 && (
    <div class="flex flex-wrap gap-2 mb-8">
      {work.subjects.map(s => (
        <span class="text-xs text-ink-500 bg-ink-800/50 border border-ink-700/30 px-2.5 py-1 rounded-full">{s}</span>
      ))}
    </div>
  )}

  {isTranslated ? (
    <Fragment>
      <div class="bg-ink-800/40 border border-ink-700/40 rounded-lg p-6 mb-6">
        <p class="text-ink-400 text-sm">Full side-by-side translation viewer with phrase highlighting will load here.</p>
      </div>
    </Fragment>
  ) : (
    <Fragment>
      {/* Source text preview — full width, clamped to ~10 lines */}
      {work.source_preview && (
        <div class="mb-10">
          <h2 class="text-sm font-mono text-ink-500 uppercase tracking-wider mb-4">Source Text Preview</h2>
          <div class="rounded-xl bg-ink-800/30 border border-ink-700/30 p-6 md:p-8 relative">
            <p class="font-arabic text-xl md:text-2xl text-ink-400 leading-[2.6] text-right source-preview-clamp" dir="rtl" lang={work.language}>
              {work.source_preview}
            </p>
            <div class="source-preview-fade"></div>
          </div>
          {work.source_url && (
            <p class="text-sm text-ink-500 mt-3">
              <a href={work.source_url} target="_blank" rel="noopener noreferrer"
                 class="text-gold-400/70 hover:text-gold-400 transition-colors">
                Read full text on Ocean of Lights &nearr;
              </a>
            </p>
          )}
        </div>
      )}

      {/* Sponsor CTA with detailed cost breakdown */}
      <div class="bg-ink-800/40 border border-gold-500/20 rounded-xl p-6 md:p-8 mb-8">
        <h2 class="text-xl font-display font-semibold text-ink-100 mb-3">Sponsor This Translation</h2>
        <p class="text-sm text-ink-400 mb-6 max-w-2xl">
          Help bring <span class="text-ink-200 italic">{work.title_english || work.title}</span> into English through
          CTAI&rsquo;s committee translation process &mdash; three AI translators deliberating over multiple rounds,
          guided by Shoghi Effendi&rsquo;s translation precedents from the Jafar concordance.
        </p>

        {est && (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            {/* Document details */}
            <div>
              <h3 class="text-xs font-mono text-ink-500 uppercase tracking-wider mb-3">Document Details</h3>
              <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <dt class="text-ink-500">Source language</dt>
                  <dd class="text-ink-300">{langName}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Word count</dt>
                  <dd class="text-ink-300 font-mono">{work.word_count.toLocaleString()}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Estimated paragraphs</dt>
                  <dd class="text-ink-300 font-mono">~{est.paras}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Category</dt>
                  <dd class="text-ink-300 capitalize">{work.category}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Translation style</dt>
                  <dd class="text-ink-300">{work.category === 'sacred' ? 'Shoghi Effendi' : 'Modern'}</dd>
                </div>
              </dl>
            </div>

            {/* Cost breakdown */}
            <div>
              <h3 class="text-xs font-mono text-ink-500 uppercase tracking-wider mb-3">Cost Estimate</h3>
              <dl class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <dt class="text-ink-500">Segmentation <span class="text-ink-600">(4 passes)</span></dt>
                  <dd class="text-ink-300 font-mono">{fmtCost(est.seg)}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Jafar research</dt>
                  <dd class="text-ink-300 font-mono">{fmtCost(est.research)}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Translation <span class="text-ink-600">(3 translators &times; 2&ndash;3 rounds)</span></dt>
                  <dd class="text-ink-300 font-mono">{fmtCost(est.trans)}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="text-ink-500">Assembly &amp; review</dt>
                  <dd class="text-ink-300 font-mono">{fmtCost(est.assembly)}</dd>
                </div>
                <div class="flex justify-between border-t border-ink-700/40 pt-2 mt-2">
                  <dt class="text-ink-200 font-medium">Total estimate</dt>
                  <dd class="text-gold-400 font-mono font-semibold text-base">{fmtCost(est.total)}</dd>
                </div>
              </dl>
              <p class="text-[10px] text-ink-600 mt-2">Includes 50% buffer for retries and complex passages.</p>
            </div>
          </div>
        )}

        <a href="/translations/" class="inline-block px-5 py-2.5 text-sm font-mono bg-gold-400/10 border border-gold-500/40 text-gold-400 rounded-lg hover:bg-gold-400/20 transition-colors">
          Sponsor Translation
        </a>
      </div>

      {/* What you get section */}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="p-4 bg-ink-800/30 rounded-lg border border-ink-700/30">
          <div class="text-gold-400 text-sm font-mono mb-2">3 Translators</div>
          <p class="text-xs text-ink-500">Three AI translators render independently, then deliberate over multiple rounds to reach consensus.</p>
        </div>
        <div class="p-4 bg-ink-800/30 rounded-lg border border-ink-700/30">
          <div class="text-gold-400 text-sm font-mono mb-2">Jafar Concordance</div>
          <p class="text-xs text-ink-500">Every significant term is cross-referenced against Shoghi Effendi&rsquo;s translation precedents.</p>
        </div>
        <div class="p-4 bg-ink-800/30 rounded-lg border border-ink-700/30">
          <div class="text-gold-400 text-sm font-mono mb-2">3 PDF Formats</div>
          <p class="text-xs text-ink-500">Side-by-side by paragraph, by sentence, and by sentence with scholarly notes.</p>
        </div>
      </div>
    </Fragment>
  )}

  {/* Links */}
  <div class="flex flex-wrap gap-4 text-sm mt-6">
    {work.source_url && (
      <a href={work.source_url} target="_blank" rel="noopener noreferrer"
         class="text-gold-400 hover:text-gold-300 underline underline-offset-2">
        View original text &nearr;
      </a>
    )}
    {work.has_english_translation && work.english_url && (
      <a href={work.english_url} target="_blank" rel="noopener noreferrer"
         class="text-gold-400 hover:text-gold-300 underline underline-offset-2">
        View English translation &nearr;
      </a>
    )}
  </div>
</Base>
